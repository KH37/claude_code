---
description: 7つの観点からリファクタリング箇所を包括的に検出する
---

コードベース全体または指定されたディレクトリ/ファイルに対して、7つの観点からリファクタリングが必要な箇所を検出します。

# 分析対象

$ARGUMENTS

（指定がない場合は、主要なソースコードディレクトリ全体を対象とする）

# 実行手順

以下の7つのサブエージェントを**並列で**起動し、それぞれの観点からリファクタリング箇所を検出してください。

## 起動するサブエージェント

1. **refactoring-advisor** - コード品質・可読性
   - 重複コードの検出（DRY原則違反）
   - 長すぎる関数（50行超）の分割
   - 不明確な命名の改善
   - マジックナンバーの定数化
   - コメントの品質改善

2. **typescript-type-safety-reviewer** - 型安全性（TypeScript）
   - `any`型の排除
   - 型ガード関数の適切な使用
   - Zodスキーマによるバリデーション統一
   - 冗長な型注釈の省略

3. **architecture-refactor-finder** - アーキテクチャ整合性
   - 層間依存ルールの遵守
   - UIコンポーネントへのビジネスロジック混入禁止
   - Hookの配置（`models/*/hooks/`に集約）

4. **api-refactoring-finder** - API設計・エラーハンドリング
   - エラーレスポンス形式の統一
   - 適切なHTTPステータスコードの使用
   - 複数テーブル操作時のトランザクション使用
   - 全エンドポイントでの認証チェック

5. **refactor-performance-finder** - パフォーマンス
   - N+1クエリの排除
   - `useMemo`/`useCallback`による再レンダリング最適化
   - 不要な依存パッケージの削除
   - `next/image`による画像最適化

6. **test-coverage-reviewer** - テストカバレッジ
   - 重要パス（認証、いいね、マッチング）のテスト有無
   - エッジケース・境界値テストの追加
   - 過度なモックの見直し

7. **security-refactor-finder** - セキュリティ
   - 全APIでのZodバリデーション
   - 認可チェック（他ユーザーリソースへのアクセス防止）
   - Drizzle ORMのパラメータ化クエリ使用
   - ログへの機密情報出力禁止

# サブエージェント起動時の指示

各サブエージェントに以下の情報を渡してください：

```
分析対象: $ARGUMENTS（または「プロジェクト全体」）

プロジェクト情報:
- CLAUDE.md, docs/ARCHITECTURE.md, docs/specification.md を参照してプロジェクト固有のルールを遵守すること
- 問題を発見した場合は、ファイルパス、行番号、問題の内容、改善案を具体的に示すこと
- 優先度（高/中/低）を付けて報告すること
```

# 結果の統合

すべてのサブエージェントの結果を受け取ったら、以下の形式で統合レポートを作成してください：

```markdown
# リファクタリング総合レポート

## 概要サマリー

| 観点                 | 問題数 | 優先度高 | 優先度中 | 優先度低 |
| -------------------- | ------ | -------- | -------- | -------- |
| コード品質・可読性   | X      | X        | X        | X        |
| 型安全性             | X      | X        | X        | X        |
| アーキテクチャ整合性 | X      | X        | X        | X        |
| API設計              | X      | X        | X        | X        |
| パフォーマンス       | X      | X        | X        | X        |
| テストカバレッジ     | X      | X        | X        | X        |
| セキュリティ         | X      | X        | X        | X        |
| **合計**             | **X**  | **X**    | **X**    | **X**    |

## 優先度高の問題（即座に対応推奨）

### [観点名] ファイル:行番号

- **問題**: 問題の説明
- **改善案**: 具体的な改善方法
- **理由**: なぜ優先度が高いのか

（以下、優先度高の問題をすべて列挙）

## 優先度中の問題（次のイテレーションで対応）

（同様のフォーマットで列挙）

## 優先度低の問題（時間があれば対応）

（同様のフォーマットで列挙）

## 推奨アクション

1. まず取り組むべき問題
2. 次に取り組むべき問題
3. ...
```

# 注意事項

- 7つのサブエージェントは**並列で**起動し、効率的に分析を行ってください
- 各サブエージェントの結果を待ってから統合レポートを作成してください
- 重複する指摘がある場合は統合して報告してください
- 実行不可能な提案は避け、具体的で実装可能な改善案を提示してください

# GitHub Issue作成

統合レポート作成後、発見した問題をGitHub issueとして登録します。

## Issue作成の手順

### 1. タスクのグループ化

発見した問題を以下の基準でグループ化し、issueを作成するか判断:

- **優先度高の問題**: 個別にissueを作成（セキュリティ・データ整合性リスクは即座に対応が必要）
- **優先度中の問題**: 観点ごとにまとめて1つのissueを作成
- **優先度低の問題**: すべてまとめて1つのissueを作成（または作成しない）

### 2. Issue作成前の確認

issueを作成する前に、以下をユーザに確認:

1. 作成予定のissue一覧（タイトルと概要）を提示
2. issueの数が多い場合（5個以上）は、作成してよいか確認を取る
3. 優先度低の問題をissue化するか確認

### 3. `gh issue create`でissueを作成

各issueは以下のフォーマットで作成:

**タイトル**: `refactor: [観点名] 問題の簡潔な説明`

**本文**:

```markdown
## 概要

[リファクタリングで解決したい問題を簡潔に]

## 背景・目的

[なぜこのリファクタリングが必要か、放置した場合のリスク]

## 対象箇所

| ファイル          | 行番号 | 問題       |
| ----------------- | ------ | ---------- |
| `path/to/file.ts` | XX-YY  | 問題の説明 |

## 実装内容

- [ ] [具体的なリファクタリングタスク1]
- [ ] [具体的なリファクタリングタスク2]
- [ ] [具体的なリファクタリングタスク3]

## 技術的検討事項

[実装時に考慮すべきポイント、トレードオフなど]

## 参考情報

- 検出した観点: [コード品質/型安全性/アーキテクチャ/API設計/パフォーマンス/テスト/セキュリティ]
- 優先度: [高/中/低]
- 関連ドキュメント: docs/ARCHITECTURE.md
```

**ラベル**: `refactoring`, `[観点に応じたラベル]`（例: `security`, `performance`, `tech-debt`）

### 4. 作成完了の報告

issueの作成が完了したら、以下を報告:

- 作成したissueの一覧（番号、タイトル、URL）
- 推奨される対応順序（依存関係がある場合）
- 次のアクションの提案
